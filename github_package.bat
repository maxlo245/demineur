@echo off
chcp 65001 >nul
echo.
echo ???????????????????????????????????????????????????????????
echo   ?? CRÉATION PACKAGE GITHUB - DÉMINEUR HD
echo ???????????????????????????????????????????????????????????
echo.

REM Vérifier si Git est installé
where git >nul 2>&1
if %ERRORLEVEL% NEQ 0 (
    echo ? ERREUR: Git n'est pas installé !
    echo.
    echo ?? Téléchargez Git : https://git-scm.com/download/win
    echo.
    pause
    exit /b 1
)

echo ?? État actuel du dépôt...
echo.
git status --short
echo.

REM Proposer les actions
echo ???????????????????????????????????????????????????????????
echo   ?? Actions disponibles:
echo ???????????????????????????????????????????????????????????
echo.
echo [1] ?? Commit simple (changements rapides)
echo [2] ?? Commit complet + Tag version (pour release)
echo [3] ?? Push uniquement
echo [4] ???  Créer tag sans commit
echo [5] ? Annuler
echo.
set /p choice="Votre choix (1-5): "

if "%choice%"=="5" (
    echo.
    echo ? Annulé.
    pause
    exit /b 0
)

REM ???????????????????????????????????????????????????????????
REM Option 1: Commit simple
REM ???????????????????????????????????????????????????????????
if "%choice%"=="1" (
    echo.
    echo ???????????????????????????????????????????????????????????
    echo   ?? COMMIT SIMPLE
    echo ???????????????????????????????????????????????????????????
    echo.
    
    set /p commit_msg="Message de commit: "
    if "%commit_msg%"=="" set commit_msg=Update
    
    git add .
    git commit -m "%commit_msg%"
    
    if %ERRORLEVEL% EQU 0 (
        echo.
        echo ? Commit créé !
        echo.
        set /p push_now="Pousser vers GitHub maintenant ? (O/N): "
        if /i "%push_now%"=="O" (
            git push origin main
            if %ERRORLEVEL% EQU 0 (
                echo.
                echo ? Push réussi !
            )
        )
    )
    goto :end
)

REM ???????????????????????????????????????????????????????????
REM Option 2: Commit complet + Tag
REM ???????????????????????????????????????????????????????????
if "%choice%"=="2" (
    echo.
    echo ???????????????????????????????????????????????????????????
    echo   ?? COMMIT COMPLET + TAG VERSION
    echo ???????????????????????????????????????????????????????????
    echo.
    
    REM Demander la version
    set /p version="Version (ex: 1.0.0): "
    if "%version%"=="" set version=1.0.0
    
    REM Demander le message de commit
    set /p commit_msg="Message de commit (ou Entrée pour 'Release v%version%'): "
    if "%commit_msg%"=="" set commit_msg=Release v%version%
    
    echo.
    echo ?? Récapitulatif:
    echo    Version: v%version%
    echo    Commit: %commit_msg%
    echo.
    set /p confirm="Confirmer ? (O/N): "
    
    if /i not "%confirm%"=="O" (
        echo ? Annulé.
        goto :end
    )
    
    echo.
    echo ???????????????????????????????????????????????????????????
    echo   ?? Création du commit...
    echo ???????????????????????????????????????????????????????????
    echo.
    
    git add .
    git commit -m "%commit_msg%"
    
    if %ERRORLEVEL% NEQ 0 (
        echo ? Échec du commit !
        goto :end
    )
    
    echo ? Commit créé !
    echo.
    
    echo ???????????????????????????????????????????????????????????
    echo   ???  Création du tag...
    echo ???????????????????????????????????????????????????????????
    echo.
    
    REM Créer le tag annoté
    git tag -a "v%version%" -m "Version %version%"
    
    if %ERRORLEVEL% NEQ 0 (
        echo ? Échec de la création du tag !
        goto :end
    )
    
    echo ? Tag v%version% créé !
    echo.
    
    echo ???????????????????????????????????????????????????????????
    echo   ?? Push vers GitHub...
    echo ???????????????????????????????????????????????????????????
    echo.
    
    REM Push le commit
    git push origin main
    
    if %ERRORLEVEL% NEQ 0 (
        echo ? Échec du push du commit !
        goto :end
    )
    
    echo ? Commit poussé !
    echo.
    
    REM Push le tag
    git push origin "v%version%"
    
    if %ERRORLEVEL% NEQ 0 (
        echo ? Échec du push du tag !
        goto :end
    )
    
    echo ? Tag poussé !
    echo.
    
    echo ???????????????????????????????????????????????????????????
    echo   ? SUCCÈS !
    echo ???????????????????????????????????????????????????????????
    echo.
    echo ?? Package créé avec succès !
    echo.
    echo ?? Prochaines étapes:
    echo    1. Allez sur: https://github.com/maxlo245/demineur/releases
    echo    2. Cliquez sur "Draft a new release"
    echo    3. Sélectionnez le tag: v%version%
    echo    4. Uploadez Demineur_HD_v%version%.zip
    echo    5. Publiez la release !
    echo.
    goto :end
)

REM ???????????????????????????????????????????????????????????
REM Option 3: Push uniquement
REM ???????????????????????????????????????????????????????????
if "%choice%"=="3" (
    echo.
    echo ???????????????????????????????????????????????????????????
    echo   ?? PUSH VERS GITHUB
    echo ???????????????????????????????????????????????????????????
    echo.
    
    git push origin main
    
    if %ERRORLEVEL% EQU 0 (
        echo.
        echo ? Push réussi !
    )
    goto :end
)

REM ???????????????????????????????????????????????????????????
REM Option 4: Tag uniquement
REM ???????????????????????????????????????????????????????????
if "%choice%"=="4" (
    echo.
    echo ???????????????????????????????????????????????????????????
    echo   ???  CRÉER UN TAG
    echo ???????????????????????????????????????????????????????????
    echo.
    
    set /p version="Version (ex: 1.0.0): "
    if "%version%"=="" set version=1.0.0
    
    git tag -a "v%version%" -m "Version %version%"
    
    if %ERRORLEVEL% NEQ 0 (
        echo ? Échec de la création du tag !
        goto :end
    )
    
    echo ? Tag v%version% créé !
    echo.
    
    set /p push_tag="Pousser le tag maintenant ? (O/N): "
    if /i "%push_tag%"=="O" (
        git push origin "v%version%"
        if %ERRORLEVEL% EQU 0 (
            echo ? Tag poussé !
        )
    )
    goto :end
)

:end
echo.
pause
