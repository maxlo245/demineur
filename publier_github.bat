@echo off
chcp 65001 >nul
echo.
echo ???????????????????????????????????????????????????????????
echo   ?? PUBLICATION GITHUB COMPLÈTE - DÉMINEUR HD
echo ???????????????????????????????????????????????????????????
echo.

echo ?? Ce script va:
echo    1. Compiler le projet en Release
echo    2. Organiser les fichiers
echo    3. Créer le package .zip
echo    4. Commit + Tag sur GitHub
echo    5. Instructions pour la release
echo.
set /p confirm="Continuer ? (O/N): "

if /i not "%confirm%"=="O" (
    echo ? Annulé.
    pause
    exit /b 0
)

echo.
echo ???????????????????????????????????????????????????????????
echo   ?? ÉTAPE 1/5: Compilation
echo ???????????????????????????????????????????????????????????
echo.

REM Vérifier si MSBuild est disponible
where msbuild >nul 2>&1
if %ERRORLEVEL% NEQ 0 (
    echo ??  MSBuild introuvable - Compilation manuelle nécessaire
    echo.
    echo ?? Ouvrez Visual Studio et:
    echo    1. Configuration: Release
    echo    2. Plateforme: x64
    echo    3. Ctrl+Shift+B
    echo.
    set /p compiled="Compilation terminée ? (O/N): "
    if /i not "%compiled%"=="O" (
        echo ? Annulé.
        pause
        exit /b 1
    )
) else (
    echo ?? Compilation automatique...
    msbuild demineur.sln /p:Configuration=Release /p:Platform=x64 /v:minimal
    if %ERRORLEVEL% NEQ 0 (
        echo ? Échec de la compilation !
        pause
        exit /b 1
    )
    echo ? Compilation réussie !
)

echo.
echo ???????????????????????????????????????????????????????????
echo   ?? ÉTAPE 2/5: Organisation
echo ???????????????????????????????????????????????????????????
echo.

call organiser_projet.bat
if %ERRORLEVEL% NEQ 0 (
    echo ? Échec de l'organisation !
    pause
    exit /b 1
)

echo.
echo ???????????????????????????????????????????????????????????
echo   ?? ÉTAPE 3/5: Musiques (Optionnel)
echo ???????????????????????????????????????????????????????????
echo.

if exist "Release\data\sounds\menu.mp3" (
    echo ? Musiques détectées dans Release\data\sounds\
) else if exist "Release\data\sounds\menu.wav" (
    echo ? Musiques détectées dans Release\data\sounds\
) else (
    echo ??  Aucune musique détectée
    echo.
    set /p add_music="Voulez-vous ajouter des musiques maintenant ? (O/N): "
    if /i "%add_music%"=="O" (
        echo.
        echo ?? Ajoutez vos musiques dans: Release\data\sounds\
        echo    - menu.mp3 ou menu.wav
        echo    - game.mp3 ou game.wav
        echo    - win.mp3 ou win.wav
        echo.
        pause
    )
)

echo.
echo ???????????????????????????????????????????????????????????
echo   ?? ÉTAPE 4/5: Création du .zip
echo ???????????????????????????????????????????????????????????
echo.

REM Demander la version
set /p version="Version pour le package (ex: 1.0.0): "
if "%version%"=="" set version=1.0.0

REM Supprimer l'ancien .zip s'il existe
if exist "Demineur_HD_v%version%.zip" (
    echo ???  Suppression de l'ancien .zip...
    del "Demineur_HD_v%version%.zip"
)

REM Créer le .zip
echo ?? Création de Demineur_HD_v%version%.zip...
powershell -Command "Compress-Archive -Path 'Release\*' -DestinationPath 'Demineur_HD_v%version%.zip' -Force"

if %ERRORLEVEL% NEQ 0 (
    echo ? Échec de la création du .zip !
    pause
    exit /b 1
)

echo ? Package créé: Demineur_HD_v%version%.zip

REM Afficher la taille
for %%A in ("Demineur_HD_v%version%.zip") do (
    set size=%%~zA
)
echo ?? Taille: %size% octets

echo.
echo ???????????????????????????????????????????????????????????
echo   ?? ÉTAPE 5/5: GitHub Commit + Tag
echo ???????????????????????????????????????????????????????????
echo.

REM Vérifier Git
where git >nul 2>&1
if %ERRORLEVEL% NEQ 0 (
    echo ? Git introuvable !
    echo.
    echo ?? Téléchargez Git: https://git-scm.com/download/win
    echo.
    goto :manual_github
)

echo ?? Statut Git:
git status --short
echo.

set /p do_commit="Créer commit + tag maintenant ? (O/N): "
if /i not "%do_commit%"=="O" (
    goto :manual_github
)

REM Message de commit
set /p commit_msg="Message de commit (ou Entrée pour 'Release v%version%'): "
if "%commit_msg%"=="" set commit_msg=Release v%version%

echo.
echo ?? Commit...
git add .
git commit -m "%commit_msg%"

if %ERRORLEVEL% NEQ 0 (
    echo ??  Aucun changement à commiter ou commit réussi
)

echo.
echo ???  Création du tag v%version%...
git tag -a "v%version%" -m "Version %version%"

if %ERRORLEVEL% NEQ 0 (
    echo ??  Le tag existe peut-être déjà
)

echo.
echo ?? Push vers GitHub...
git push origin main

if %ERRORLEVEL% NEQ 0 (
    echo ??  Avertissement lors du push du commit
)

echo.
git push origin "v%version%"

if %ERRORLEVEL% NEQ 0 (
    echo ??  Avertissement lors du push du tag
)

:manual_github

echo.
echo ???????????????????????????????????????????????????????????
echo   ? PUBLICATION TERMINÉE !
echo ???????????????????????????????????????????????????????????
echo.
echo ?? Package créé: Demineur_HD_v%version%.zip
echo ???  Tag: v%version%
echo.
echo ?? PROCHAINES ÉTAPES:
echo.
echo 1. Aller sur GitHub:
echo    https://github.com/maxlo245/demineur/releases
echo.
echo 2. Cliquer sur "Draft a new release"
echo.
echo 3. Sélectionner le tag: v%version%
echo.
echo 4. Titre: ?? Démineur HD v%version% - Version Initiale
echo.
echo 5. Uploader le fichier: Demineur_HD_v%version%.zip
echo.
echo 6. Copier la description depuis: GITHUB_RELEASE_GUIDE.md
echo.
echo 7. Publier !
echo.
echo ???????????????????????????????????????????????????????????
echo.
echo ?? CONSEILS:
echo    - Ajoutez une capture d'écran du jeu
echo    - Testez le .zip sur un autre PC
echo    - Annoncez sur Reddit, Discord, etc.
echo.
echo ?? Guide complet: GITHUB_RELEASE_GUIDE.md
echo.
echo ???????????????????????????????????????????????????????????
echo.
set /p open_github="Ouvrir GitHub maintenant ? (O/N): "
if /i "%open_github%"=="O" (
    start https://github.com/maxlo245/demineur/releases/new
)

echo.
echo ?? Bon succès avec votre publication ! ??
echo.
pause
